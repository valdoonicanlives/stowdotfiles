local M = {}

local function generate_mapping(seed)
  math.randomseed(seed)
  local charset = {}
  for i = 32, 126 do table.insert(charset, string.char(i)) end
  local unpack = unpack or table.unpack
  local shuffled = { unpack(charset) }
  for i = #shuffled, 2, -1 do
    local j = math.random(i)
    shuffled[i], shuffled[j] = shuffled[j], shuffled[i]
  end
  local map, reverse = {}, {}
  for i, c in ipairs(charset) do
    map[c] = shuffled[i]
    reverse[shuffled[i]] = c
  end
  return map, reverse
end

local function transform_text(text, map)
  local result = {}
  for i = 1, #text do
    local c = text:sub(i, i)
    table.insert(result, map[c] or c)
  end
  return table.concat(result)
end

local function transform_lines(start_line, end_line, map)
  local bufnr = vim.api.nvim_get_current_buf()
  local lines = vim.api.nvim_buf_get_lines(bufnr, start_line, end_line, false)
  for i, line in ipairs(lines) do
    lines[i] = transform_text(line, map)
  end
  vim.api.nvim_buf_set_lines(bufnr, start_line, end_line, false, lines)
end

function M.scramble_cmd(opts)
  local map = generate_mapping(12345)
  local start_line = (opts.line1 or 1) - 1
  local end_line = opts.line2 or -1
  transform_lines(start_line, end_line, map)
end

function M.unscramble_cmd(opts)
  local _, reverse = generate_mapping(12345)
  local start_line = (opts.line1 or 1) - 1
  local end_line = opts.line2 or -1
  transform_lines(start_line, end_line, reverse)
end

function M.setup()
  vim.api.nvim_create_user_command("Scramble", M.scramble_cmd, { range = "%" })
  vim.api.nvim_create_user_command("Unscramble", M.unscramble_cmd, { range = "%" })
end

return M
